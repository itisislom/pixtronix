<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Фоторедактор</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #2a2a2a;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: #1a1a1a;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }

        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .tools-panel {
            width: 40px;
            background-color: #2a2a2a;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            margin: 2px;
            border: 1px solid #444;
            background: #333;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background-color 0.2s;
        }

        .tool-btn:hover {
            background: #444;
        }

        .tool-btn.active {
            background: #555;
            border-color: #666;
        }

        .tool-btn .tooltip {
            position: absolute;
            left: 45px;
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
            pointer-events: none;
        }

        .tool-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .canvas-area {
            flex: 1;
            background: #1a1a1a;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .canvas-container {
            position: relative;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABZ0RVh0Q3JlYXRpb24gVGltZQAxMC8yOS8xMiKqq3kAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAAAHklEQVQ4jWNgYGBgYHjy5Ml/hjF+BiYGBgYGBgYGBgYA1pkFNYVXfH4AAAAASUVORK5CYII=');
        }

        #canvas {
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: block;
        }

        .properties-panel {
            width: 250px;
            background-color: #2a2a2a;
            border-left: 1px solid #444;
        }

        .panel-section {
            border-bottom: 1px solid #444;
            padding: 15px;
            display: none;
        }

        .panel-section.active {
            display: block;
        }

        .panel-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #444;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="number"] {
            width: 50px;
            background: #444;
            border: none;
            color: #fff;
            padding: 3px 5px;
            border-radius: 3px;
        }

        .color-picker {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .cursor-overlay {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
        }

        .nav-btn {
            background: #333;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .nav-btn:hover {
            background: #444;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: #333;
            padding: 5px;
            border-radius: 4px;
            z-index: 1000;
        }

        .zoom-btn {
            background: #444;
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #555;
        }

        .zoom-level {
            background: #444;
            padding: 0 10px;
            display: flex;
            align-items: center;
            border-radius: 4px;
            color: white;
            min-width: 70px;
            justify-content: center;
        }

        .project-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-name-text {
            cursor: pointer;
        }

        .project-name-text:hover {
            color: #8A2BE2;
        }

        .project-name-input {
            background: #444;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            width: 200px;
            display: none;
        }

        .edit-name-btn {
            opacity: 0;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 14px;
        }

        .project-name:hover .edit-name-btn {
            opacity: 1;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px;
            }

            .project-info {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .workspace {
                flex-direction: column;
            }

            .tools-panel {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                position: fixed;
                bottom: 0;
                left: 0;
                background: #2a2a2a;
                padding: 10px;
                display: flex;
                justify-content: space-around;
                z-index: 1000;
            }

            .tool-btn {
                width: 40px;
                height: 40px;
                margin: 0 5px;
            }

            .tool-btn .tooltip {
                display: none; /* Скрываем подсказки на мобильных */
            }

            .canvas-area {
                height: calc(100vh - 200px);
                touch-action: none; /* Для лучшей работы с тач-событиями */
            }

            .properties-panel {
                width: 100%;
                height: auto;
                max-height: 250px;
                overflow-y: auto;
            }

            .panel-section {
                padding: 10px;
            }

            .control-row {
                margin-bottom: 15px;
            }

            .control-row label {
                min-width: 100px;
            }

            input[type="range"] {
                height: 20px; /* Увеличиваем для удобства на тач-устройствах */
            }

            input[type="number"] {
                width: 60px;
                padding: 8px;
                font-size: 16px;
            }

            .color-picker {
                height: 40px;
            }

            .zoom-controls {
                bottom: auto;
                top: 10px;
                right: 10px;
            }

            .zoom-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            /* Улучшаем touch-target размеры */
            .nav-btn {
                padding: 12px 20px;
                font-size: 16px;
                min-height: 44px;
            }

            /* Стили для модальных окон на мобильных */
            .confirm-dialog {
                width: 90%;
                max-width: 320px;
            }

            .dialog-btn {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }

            .canvas-container {
                margin-bottom: 60px; /* Отступ для панели инструментов */
            }

            .settings-panel {
                position: fixed;
                top: 0;
                right: 0;
                width: 100%;
                max-height: 40vh;
                transform: translateY(-100%);
                transition: transform 0.3s;
                z-index: 1000;
            }

            .settings-panel.show {
                transform: translateY(0);
            }

            /* Кнопка для показа/скрытия настроек */
            .settings-toggle {
                display: block;
                position: fixed;
                top: 60px;
                right: 10px;
                padding: 8px;
                background: #2a2a2a;
                border-radius: 50%;
                z-index: 1001;
            }
        }

        /* Добавляем поддержку жестов */
        @media (hover: none) {
            .tool-btn:hover {
                background-color: #333;
            }

            .tool-btn:active {
                background-color: #444;
            }

            .nav-btn:active {
                transform: scale(0.98);
            }
        }

        /* Стили для кнопок истории */
        .history-controls {
            display: flex;
            gap: 5px;
            margin-right: 10px;
        }

        .history-controls button {
            width: 30px;
            height: 30px;
            font-size: 18px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Стили для модального окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .format-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        /* Стили для toast уведомления */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
            }
            to {
                transform: translate(-50%, 0);
            }
        }

        /* Стили для тач-событий */
        .canvas-container {
            touch-action: none;
        }
    </style>

    <script>
    // Добавляем поддержку тач-событий
    let touchStartX = 0;
    let touchStartY = 0;

    function initTouchEvents() {
        const canvas = document.getElementById('canvas');

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            
            const pos = getTouchPosition(touch);
            isDrawing = true;
            lastX = pos.x;
            lastY = pos.y;

            if (currentTool === 'fill') {
                fill(touch);
            }
        });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const touch = e.touches[0];
            const pos = getTouchPosition(touch);

            switch(currentTool) {
                case 'brush':
                    draw(touch);
                    break;
                case 'eraser':
                    erase(touch);
                    break;
            }
        });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            isDrawing = false;
            saveToHistory();
        });
    }

    function getTouchPosition(touch) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        return {
            x: (touch.clientX - rect.left) * scaleX,
            y: (touch.clientY - rect.top) * scaleY
        };
    }

    // Добавляем переключатель панели настроек
    function toggleSettings() {
        const panel = document.querySelector('.settings-panel');
        panel.classList.toggle('show');
    }

    // Инициализация мобильных функций
    window.addEventListener('load', function() {
        initTouchEvents();
        
        // Добавляем кнопку переключения настроек для мобильных устройств
        if (window.innerWidth <= 768) {
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'settings-toggle';
            toggleBtn.innerHTML = '⚙️';
            toggleBtn.onclick = toggleSettings;
            document.body.appendChild(toggleBtn);
        }

        // Предотвращаем зум на мобильных устройствах
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    });

    // Обновляем функцию getCanvasCoordinates для поддержки тач-событий
    function getCanvasCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        if (e.touches) {
            const touch = e.touches[0];
            return {
                x: (touch.clientX - rect.left) * scaleX,
                y: (touch.clientY - rect.top) * scaleY
            };
        }
        
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }
    </script>
</head>
<body>
    <div class="header">
        <div class="project-info">
            <button onclick="window.location.href='index.html'" class="nav-btn">← Назад</button>
            <div class="history-controls">
                <button onclick="undo()" class="nav-btn" id="undoBtn" disabled>↶</button>
                <button onclick="redo()" class="nav-btn" id="redoBtn" disabled>↷</button>
            </div>
            <div class="project-name">
                <span class="project-name-text" onclick="startEditing()"
                      id="projectName">Без названия</span>
                <input type="text" class="project-name-input" id="projectNameInput">
                <span class="edit-name-btn" onclick="startEditing()">✎</span>
            </div>
        </div>
        <div class="header-controls">
            <button onclick="showDownloadDialog()" class="nav-btn">Скачать</button>
            <button onclick="saveProject()" class="nav-btn">Сохранить</button>
        </div>
    </div>

    <div class="workspace">
        <div class="tools-panel">
            <button class="tool-btn" data-tool="move" title="Перемещение (M)">
                <i class="fas fa-arrows-alt">↔</i>
            </button>
            <button class="tool-btn" data-tool="brush">
                🖌
                <span class="tooltip">Кисть (B)</span>
            </button>
            <button class="tool-btn" data-tool="fill">
                🪣
                <span class="tooltip">Заливка (G)</span>
            </button>
            <button class="tool-btn" data-tool="eraser" title="Ластик (E)">
                <i class="fas fa-eraser">🧹</i>
            </button>
        </div>

        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(-0.1)">-</button>
                <div class="zoom-level">100%</div>
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
            </div>
        </div>

        <div class="properties-panel">
            <div class="panel-section brush-settings">
                <div class="panel-title">Настройки кисти</div>
                <div class="control-group">
                    <div class="control-row">
                        <label>Размер:</label>
                        <input type="range" id="brushSize" min="1" max="100" value="20">
                        <input type="number" id="brushSizeNum" min="1" max="100" value="20">
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-row">
                        <label>Непрозрачность:</label>
                        <input type="range" id="brushOpacity" min="1" max="100" value="100">
                        <input type="number" id="brushOpacityNum" min="1" max="100" value="100">
                    </div>
                </div>
                <div class="control-group">
                    <div class="panel-title">Цвет</div>
                    <input type="color" id="brushColor" class="color-picker" value="#000000">
                </div>
            </div>

            <div class="panel-section fill-settings">
                <div class="panel-title">Настройки заливки</div>
                <div class="control-group">
                    <div class="control-row">
                        <label>Допуск:</label>
                        <input type="range" id="fillTolerance" min="0" max="100" value="32">
                        <input type="number" id="fillToleranceNum" min="0" max="100" value="32">
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-row">
                        <label>Непрозрачность:</label>
                        <input type="range" id="fillOpacity" min="1" max="100" value="100">
                        <input type="number" id="fillOpacityNum" min="1" max="100" value="100">
                    </div>
                </div>
                <div class="control-group">
                    <div class="panel-title">Цвет</div>
                    <input type="color" id="fillColor" class="color-picker" value="#000000">
                </div>
            </div>

            <div class="panel-section eraser-settings">
                <div class="panel-title">Настройки ластика</div>
                <div class="control-group">
                    <div class="control-row">
                        <label>Размер:</label>
                        <input type="range" id="eraserSize" min="1" max="100" value="20">
                        <input type="number" id="eraserSizeNum" min="1" max="100" value="20">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cursor-overlay"></div>

    <div id="downloadDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Выберите формат</h3>
            <div class="format-buttons">
                <button onclick="downloadImage('png')" class="nav-btn">PNG</button>
                <button onclick="downloadImage('jpg')" class="nav-btn">JPG</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let currentProject = null;
        let currentTool = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let zoomLevel = 1;
        const zoomLevelDisplay = document.querySelector('.zoom-level');

        // История действий
        let history = [];
        let historyIndex = -1;

        // Сохраняем состояние в историю
        function saveToHistory() {
            // Обрезаем историю до текущего индекса
            history = history.slice(0, historyIndex + 1);
            
            // Добавляем новое состояние
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            history.push(imageData);
            historyIndex++;
            
            updateHistoryButtons();
        }

        // Обновляем состояние кнопок истории
        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = historyIndex <= 0;
            document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
        }

        // Отмена действия (Ctrl+Z)
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                ctx.putImageData(history[historyIndex], 0, 0);
                updateHistoryButtons();
            }
        }

        // Возврат действия (Ctrl+Y)
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                ctx.putImageData(history[historyIndex], 0, 0);
                updateHistoryButtons();
            }
        }

        // Функция ластика
        function erase(e) {
            if (!isDrawing || currentTool !== 'eraser') return;

            const pos = getCanvasCoordinates(e);
            const eraserSize = parseInt(document.getElementById('eraserSize').value);
            
            ctx.save();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, eraserSize / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        // Диалог скачивания
        function showDownloadDialog() {
            document.getElementById('downloadDialog').style.display = 'flex';
        }

        function downloadImage(format) {
            const link = document.createElement('a');
            link.download = `${currentProject.name || 'image'}.${format}`;
            
            if (format === 'jpg') {
                link.href = canvas.toDataURL('image/jpeg', 0.8);
            } else {
                link.href = canvas.toDataURL('image/png');
            }
            
            link.click();
            document.getElementById('downloadDialog').style.display = 'none';
        }

        // Toast уведомление
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Инициализация проекта
        async function loadProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (!projectId) {
                window.location.href = 'index.html';
                return;
            }

            const projects = JSON.parse(localStorage.getItem('photoEditorProjects') || '[]');
            currentProject = projects.find(p => p.id === projectId);

            if (!currentProject) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('projectName').textContent = currentProject.name;

            if (currentProject.imageData) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    saveToHistory(); // Сохраняем начальное состояние после загрузки
                };
                img.src = currentProject.imageData;
            } else {
                canvas.width = currentProject.width || 800;
                canvas.height = currentProject.height || 600;
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveToHistory(); // Сохраняем начальное состояние
            }
        }

        // Управление инструментами
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tool = btn.dataset.tool;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = tool;
                
                // Обновляем видимость панелей настроек
                document.querySelectorAll('.panel-section').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.querySelector(`.${tool}-settings`)?.classList.add('active');
            });
        });

        function updateCursor() {
            switch(currentTool) {
                case 'move':
                    document.body.style.cursor = 'grab';
                    break;
                case 'brush':
                    document.body.style.cursor = 'crosshair';
                    break;
                case 'fill':
                    document.body.style.cursor = 'crosshair';
                    break;
                case 'eraser':
                    document.body.style.cursor = 'crosshair';
                    break;
                default:
                    document.body.style.cursor = 'default';
            }
        }

        function updatePanelVisibility() {
            document.querySelectorAll('.panel-section').forEach(panel => {
                panel.classList.remove('active');
            });
            if (currentTool) {
                document.querySelector(`.${currentTool}-settings`)?.classList.add('active');
            }
        }

        // Обновляем функцию получения координат с учетом масштаба
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            return {
                x: (clientX - rect.left) / zoomLevel,
                y: (clientY - rect.top) / zoomLevel
            };
        }

        // Обновляем функцию startDrawing
        function startDrawing(e) {
            if (currentTool !== 'brush') return;
            isDrawing = true;
            const pos = getCanvasCoordinates(e);
            lastX = pos.x;
            lastY = pos.y;
            draw(e);
        }

        // Обновляем функцию draw
        function draw(e) {
            if (!isDrawing || currentTool !== 'brush') return;

            const pos = getCanvasCoordinates(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            
            ctx.lineWidth = document.getElementById('brushSize').value / zoomLevel; // Корректируем размер кисти
            ctx.lineCap = 'round';
            ctx.strokeStyle = document.getElementById('brushColor').value;
            ctx.globalAlpha = document.getElementById('brushOpacity').value / 100;
            
            ctx.stroke();
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.globalAlpha = 1;
        }

        // Функция заливки
        function fill(e) {
            if (currentTool !== 'fill') return;

            const pos = getCanvasCoordinates(e);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            
            const startPos = (Math.floor(pos.y) * canvas.width + Math.floor(pos.x)) * 4;
            const startR = pixels[startPos];
            const startG = pixels[startPos + 1];
            const startB = pixels[startPos + 2];
            const startA = pixels[startPos + 3];

            const fillColor = document.getElementById('fillColor').value;
            const r = parseInt(fillColor.slice(1, 3), 16);
            const g = parseInt(fillColor.slice(3, 5), 16);
            const b = parseInt(fillColor.slice(5, 7), 16);
            const a = Math.floor((document.getElementById('fillOpacity').value / 100) * 255);

            const tolerance = parseInt(document.getElementById('fillTolerance').value);

            // Функция проверки цвета
            function matchesColor(x, y) {
                const index = (y * canvas.width + x) * 4;
                const dr = Math.abs(pixels[index] - startR);
                const dg = Math.abs(pixels[index + 1] - startG);
                const db = Math.abs(pixels[index + 2] - startB);
                const da = Math.abs(pixels[index + 3] - startA);
                
                return (dr + dg + db + da) <= tolerance * 4;
            }

            // Функция заливки пикселя
            function fillPixel(x, y) {
                const index = (y * canvas.width + x) * 4;
                pixels[index] = r;
                pixels[index + 1] = g;
                pixels[index + 2] = b;
                pixels[index + 3] = a;
            }

            // Алгоритм заливки
            const stack = [[Math.floor(pos.x), Math.floor(pos.y)]];
            const visited = new Set();

            while (stack.length) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;

                if (visited.has(key)) continue;
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                if (!matchesColor(x, y)) continue;

                fillPixel(x, y);
                visited.add(key);

                stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }

            ctx.putImageData(imageData, 0, 0);
            saveToHistory();
        }

        // Добавляем обработчики событий для заливки
        canvas.addEventListener('click', function(e) {
            if (currentTool === 'fill') {
                fill(e);
            }
        });

        // Обработчики событий холста
        canvas.addEventListener('mousedown', function(e) {
            isDrawing = true;
            const pos = getCanvasCoordinates(e);
            lastX = pos.x;
            lastY = pos.y;
            
            if (currentTool === 'eraser') {
                erase(e);
            } else if (currentTool === 'brush') {
                draw(e);
            }
        });

        canvas.addEventListener('mousemove', function(e) {
            if (!isDrawing) return;
            
            if (currentTool === 'eraser') {
                erase(e);
            } else if (currentTool === 'brush') {
                draw(e);
            }
        });

        canvas.addEventListener('mouseup', function() {
            if (isDrawing) {
                isDrawing = false;
                saveToHistory();
            }
        });

        canvas.addEventListener('mouseleave', function() {
            isDrawing = false;
        });

        // Поддержка масштабирования колесиком мыши
        let initialPinchDistance = null;
        let initialScale = 1;

        canvas.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                initialPinchDistance = getPinchDistance(e);
                initialScale = zoomLevel;
            }
        });

        canvas.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = getPinchDistance(e);
                if (initialPinchDistance) {
                    const newScale = initialScale * (currentDistance / initialPinchDistance);
                    changeZoom(newScale - zoomLevel);
                }
            }
        });

        function getPinchDistance(e) {
            return Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
        }

        // Сохранение проекта
        function saveProject() {
            if (!currentProject) return;

            currentProject.imageData = canvas.toDataURL();
            currentProject.preview = canvas.toDataURL();
            currentProject.lastModified = Date.now();

            const projects = JSON.parse(localStorage.getItem('photoEditorProjects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === currentProject.id);

            if (projectIndex !== -1) {
                projects[projectIndex] = currentProject;
            } else {
                projects.push(currentProject);
            }

            localStorage.setItem('photoEditorProjects', JSON.stringify(projects));
            showToast('Успешно сохранено!');
        }

        // Обновляем функцию changeZoom
        function changeZoom(delta) {
            const oldZoom = zoomLevel;
            zoomLevel = Math.max(0.1, Math.min(5, zoomLevel + delta));
            
            const container = document.querySelector('.canvas-container');
            container.style.transform = `scale(${zoomLevel})`;
            
            // Обновляем размер кисти в интерфейсе
            const brushSize = document.getElementById('brushSize');
            const brushSizeNum = document.getElementById('brushSizeNum');
            brushSize.value = parseInt(brushSize.value * oldZoom / zoomLevel);
            brushSizeNum.value = brushSize.value;
            
            zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        }

        // Добавляем масштабирование колесиком мыши
        document.querySelector('.canvas-area').addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                changeZoom(delta);
            }
        });

        // Инициализация
        window.addEventListener('load', function() {
            loadProject();
            
            // Синхронизация всех ползунков
            syncInputs('brushSize', 'brushSizeNum');
            syncInputs('brushOpacity', 'brushOpacityNum');
            syncInputs('fillTolerance', 'fillToleranceNum');
            syncInputs('fillOpacity', 'fillOpacityNum');
            syncInputs('eraserSize', 'eraserSizeNum');

            // Устанавливаем начальный масштаб
            changeZoom(0);
        });

        // Синхронизация ползунков
        function syncInputs(rangeId, numberId) {
            const range = document.getElementById(rangeId);
            const number = document.getElementById(numberId);
            
            if (range && number) {
                range.addEventListener('input', () => number.value = range.value);
                number.addEventListener('input', () => range.value = number.value);
            }
        }

        // Горячие клавиши
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === 'z' || e.key === 'Z')) {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && (e.key === 'y' || e.key === 'Y' || e.key === 'й' || e.key === 'Й')) {
                e.preventDefault();
                redo();
            }
        });

        // Добавляем функции редактирования имени
        function startEditing() {
            const nameText = document.getElementById('projectName');
            const nameInput = document.getElementById('projectNameInput');
            
            nameText.style.display = 'none';
            nameInput.style.display = 'block';
            nameInput.value = nameText.textContent;
            nameInput.focus();
            
            nameInput.onblur = () => finishEditing();
            nameInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    finishEditing();
                }
            };
        }

        function finishEditing() {
            const nameText = document.getElementById('projectName');
            const nameInput = document.getElementById('projectNameInput');
            const newName = nameInput.value.trim();
            
            if (newName && currentProject) {
                currentProject.name = newName;
                nameText.textContent = newName;
                
                const projects = JSON.parse(localStorage.getItem('photoEditorProjects') || '[]');
                const projectIndex = projects.findIndex(p => p.id === currentProject.id);
                
                if (projectIndex !== -1) {
                    projects[projectIndex].name = newName;
                    localStorage.setItem('photoEditorProjects', JSON.stringify(projects));
                }
            }
            
            nameText.style.display = 'block';
            nameInput.style.display = 'none';
        }
    </script>
</body>
</html>